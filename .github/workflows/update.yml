name: Update Website from JSON

on:
  workflow_dispatch:  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-website:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Download and process JSON data
      run: |
        # ä¸‹è½½JSONæ–‡ä»¶
        echo "æ­£åœ¨ä»APIä¸‹è½½æ•°æ®..."
        curl -s "https://api-overseas.retiehe.com/backend/host-v3/site/export-json?domain=tiangua&username=b6sbpkovf4" -o website_data.json
        
        # åˆ›å»ºå¤„ç†è„šæœ¬
        cat > process_json.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        try {
          // è¯»å–ä¸‹è½½çš„JSONæ–‡ä»¶
          const rawData = fs.readFileSync('website_data.json', 'utf8');
          const data = JSON.parse(rawData);
          
          console.log('å¼€å§‹å¤„ç†ç½‘é¡µæ–‡ä»¶...');
          let fileCount = 0;
          
          // éå†JSONå¯¹è±¡ï¼Œå†™å…¥å¯¹åº”çš„ç½‘é¡µæ–‡ä»¶
          for (const [filename, content] of Object.entries(data)) {
            // è·³è¿‡ settings.rth
            if (filename === 'settings.rth') {
              console.log('è·³è¿‡ settings.rth');
              continue;
            }
            
            // ç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆå¦‚æœæœ‰å­ç›®å½•çš„è¯ï¼‰
            const dir = path.dirname(filename);
            if (dir && dir !== '.') {
              fs.mkdirSync(dir, { recursive: true });
            }
            
            // å†™å…¥æ–‡ä»¶
            fs.writeFileSync(filename, content);
            console.log(`âœ… å·²åˆ›å»º: ${filename}`);
            fileCount++;
          }
          
          // åˆ é™¤åŸå§‹çš„JSONæ–‡ä»¶
          fs.unlinkSync('website_data.json');
          console.log(`ğŸ—‘ï¸ å·²åˆ é™¤åŸå§‹JSONæ–‡ä»¶`);
          console.log(`ğŸ‰ å¤„ç†å®Œæˆï¼å…±åˆ›å»º ${fileCount} ä¸ªç½‘é¡µæ–‡ä»¶`);
          
        } catch (error) {
          console.error('âŒ å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™:', error);
          process.exit(1);
        }
        EOF
        
        # è¿è¡Œå¤„ç†è„šæœ¬
        node process_json.js
        
    - name: Check for changes
      id: check_changes
      run: |
        git add .
        if git diff-index --quiet HEAD --; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œå‡†å¤‡æäº¤"
        fi
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "Auto-update website files from JSON API [skip ci]"
        git push